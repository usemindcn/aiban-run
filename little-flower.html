<!DOCTYPE html><html lang="zh"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜…æƒ³å®¶å°çº¢èŠ±è®¡æ•°å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&amp;family=Nunito:wght@400;600;700&amp;display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF85A1',
                        secondary: '#FFC0D3',
                        accent: '#FF5C8D',
                        girl: {
                            pink: '#FF85A1',
                            lightpink: '#FFC0D3',
                            hotpink: '#FF5C8D',
                            lavender: '#E6E6FA',
                            peach: '#FFDAB9',
                            blush: '#FFB6C1',
                        },
                        pastel: {
                            green: '#9DDAC6',
                            blue: '#98D1EB',
                            yellow: '#FFE082',
                            pink: '#FFB6C1',
                            purple: '#D8BFD8'
                        }
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                        '3xl': '2rem'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #FFE6EE; /* æ›´ç®€æ´çš„æµ…ç²‰è‰² */
        }
        
        .dark body {
            background-color: #332E3C; /* æš—è‰²æ¨¡å¼ä¸‹çš„æ·±ç´«ç²‰è‰² */
        }
        
        .score-change {
            position: absolute;
            animation: float-up 1s forwards;
            font-weight: bold;
            pointer-events: none;
            font-size: 1.2rem;
        }
        
        @keyframes float-up {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-40px);
            }
        }
        
        .card {
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(255, 133, 161, 0.15);
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .score-card {
            background-color: white;
            border-color: #FFC0D3;
        }
        
        .timer-card {
            background-color: white;
            border-color: #98D1EB;
        }
        
        .dark .score-card {
            background-color: #2D2A33;
            color: white;
            border-color: #FF85A1;
        }
        
        .dark .timer-card {
            background-color: #2D2A33;
            color: white;
            border-color: #74c0e3;
        }
        
        .button-container {
            position: relative;
        }

        .flower {
            display: inline-block;
            color: #FF5C8D;
            font-size: 1.5rem;
            animation: appear 0.5s ease-out;
            margin: 0 2px;
            filter: drop-shadow(0 0 2px rgba(255, 92, 141, 0.3));
        }
        
        @keyframes appear {
            0% {
                transform: scale(0) rotate(-45deg);
                opacity: 0;
            }
            70% {
                transform: scale(1.2) rotate(15deg);
            }
            100% {
                transform: scale(1) rotate(0);
                opacity: 1;
            }
        }

        .flower-icon {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .cute-button {
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(255, 133, 161, 0.2);
            transition: all 0.2s;
            transform: translateY(0);
        }
        
        .cute-button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 2px rgba(255, 133, 161, 0.1);
        }
        
        .add-button {
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            transform: translateY(0);
        }
        
        .add-button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 2px rgba(0, 0, 0, 0.1);
        }
        
        .bounce {
            animation: bounce 0.5s;
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        /* å¥–å“æ¨¡æ€çª—å£ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 20px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
            box-shadow: 0 10px 25px rgba(255, 133, 161, 0.3);
            border: 3px solid #FFC0D3;
        }
        
        .dark .modal-content {
            background-color: #2D2A33;
            color: white;
            border-color: #FF85A1;
        }
        
        .modal.show .modal-content {
            transform: scale(1);
        }
        
        .reward-item {
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .reward-item:hover {
            transform: translateY(-3px);
        }
        
        .reward-item.selected {
            border-color: #FF85A1;
            background-color: rgba(255, 133, 161, 0.1);
        }
        
        .dark .reward-item.selected {
            background-color: rgba(255, 133, 161, 0.2);
        }
        
        .reward-price {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #FF5C8D;
        }
        
        .reward-price .flower {
            font-size: 1rem;
            margin-left: 4px;
        }
        
        .reward-image {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s;
        }
        
        @keyframes success-animation {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-animation {
            animation: success-animation 0.5s;
        }
        
        .exchange-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(255, 133, 161, 0.3);
            z-index: 100;
            display: none;
            border: 2px solid #FFC0D3;
        }
        
        .dark .exchange-notification {
            background-color: #2D2A33;
            color: white;
            border-color: #FF85A1;
        }
        
        .notification-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .btn-pink-gradient {
            background: linear-gradient(to right, #FF85A1, #FF5C8D);
        }
        
        .btn-pink-gradient:hover {
            background: linear-gradient(to right, #FF7694, #FF4D7E);
        }
        
        /* å†å²è®°å½•è¡¨æ ¼æ ·å¼ */
        .history-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .history-table th,
        .history-table td {
            padding: 8px 12px;
            text-align: left;
        }
        
        .history-table th {
            background-color: #FFF0F5;
            font-weight: 600;
        }
        
        .dark .history-table th {
            background-color: #3A3644;
        }
        
        .history-table tr:nth-child(even) {
            background-color: rgba(255, 192, 211, 0.1);
        }
        
        .dark .history-table tr:nth-child(even) {
            background-color: rgba(255, 192, 211, 0.05);
        }
        
        .history-table tr:hover {
            background-color: rgba(255, 192, 211, 0.2);
        }
        
        /* æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .data-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #FF5C8D;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 999;
        }
        
        .data-status.show {
            opacity: 1;
        }
        
        .dark .data-status {
            background-color: rgba(45, 42, 51, 0.8);
            color: #FFB6C1;
        }
        
        /* Tabå†…å®¹æ ·å¼ */
        .tab-content {
            display: none;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ç»ç’ƒæ•ˆæœ */
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(255, 133, 161, 0.15);
        }
        
        .dark .glass {
            background: rgba(45, 42, 51, 0.7);
            box-shadow: 0 4px 15px rgba(20, 20, 35, 0.3);
            border: 1px solid rgba(80, 80, 100, 0.2);
        }
        
        /* è®¾ç½®é¡µé¢æ ·å¼ */
        .setting-item {
            background-color: white;
            border-radius: 10px;
            margin-bottom: 10px;
            padding: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .dark .setting-item {
            background-color: #2a2a3c;
        }
        
        /* ç»Ÿè®¡å›¾è¡¨å®¹å™¨ */
        .log-container {
            max-height: 250px;
            overflow-y: auto;
        }
        
        /* å½©è‰²è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            position: relative;
            width: 100%;
            height: 60px; /* å¢åŠ é«˜åº¦ä»¥ç¡®ä¿å®Œæ•´æ˜¾ç¤º */
            background-color: #f1f1f1;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .dark .progress-container {
            background-color: #333344;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 20px;
            background: linear-gradient(to right, #FFA8C4, #FF85A1, #FF5C8D);
            width: 0;
            transition: width 1s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(255, 92, 141, 0.5);
        }
        
        .progress-marker {
            position: absolute;
            top: -5px; /* è°ƒæ•´æ ‡è®°ä½ç½®ä½¿å…¶åœ¨è¿›åº¦æ¡ä¸Šæ–¹æ›´åˆé€‚çš„ä½ç½® */
            transform: translateX(-50%);
            z-index: 10;
            text-align: center;
        }
        
        .progress-marker-icon {
            font-size: 1.8rem; /* å¢åŠ å›¾æ ‡å¤§å° */
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }
        
        .progress-marker-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: #666;
            margin-top: -5px;
        }
        
        .dark .progress-marker-label {
            color: #bbb;
        }
    </style>
</head>
<body class="pb-20">
    <!-- æ ‡ç­¾å†…å®¹ -->
    <div class="container mx-auto p-4 max-w-md">
        <!-- Tab 1: è®°å½• -->
        <div id="tab1" class="tab-content active">
            <h1 class="text-3xl font-bold text-center text-girl-hotpink dark:text-girl-lightpink mb-6">
                é˜…æƒ³å®¶å°çº¢èŠ±è®¡æ•°å™¨
                <span class="flower">ğŸŒº</span>
            </h1>
            
            <!-- æ€»åˆ†æ•°æ˜¾ç¤º -->
            <div class="card score-card p-6 mb-6 text-center transition-colors duration-300">
                <h2 class="text-xl text-girl-hotpink dark:text-girl-lightpink mb-3 font-bold">å°çº¢èŠ±æ€»æ•°</h2>
                <div class="flex justify-center items-center">
                    <div class="text-5xl font-bold text-girl-hotpink" id="total-score">0</div>
                    <!-- ç§»é™¤äº† "/ 220" æ˜¾ç¤º -->
                </div>
                
                <!-- å½©è‰²è¿›åº¦æ¡ -->
                <div class="mt-4">
                    <div class="progress-container">
                        <div class="progress-bar" id="flower-progress-bar"></div>
                        <!-- è¿›åº¦æ ‡è®°å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <!-- ç§»é™¤äº†è¿›åº¦æ¡ä¸‹æ–¹çš„åˆ»åº¦æ˜¾ç¤º -->
                </div>
                
                <!-- å…‘æ¢æŒ‰é’® -->
                <button id="exchange-button" class="mt-4 btn-pink-gradient text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition-all duration-300 hover:scale-105">
                    <span class="flex items-center justify-center">
                        ğŸ å…‘æ¢å¥–å“
                    </span>
                </button>
            </div>
            
            <!-- è®¡æ—¶å™¨ -->
            <div class="card timer-card p-5 mb-6 transition-colors duration-300">
                <h2 class="text-xl text-blue-600 dark:text-blue-300 mb-3 text-center font-bold">å­¦ä¹ æ—¶é—´</h2>
                <div class="text-3xl font-mono text-center text-gray-700 dark:text-gray-100" id="timer">00:00:00</div>
                <div class="flex justify-center mt-4 space-x-3">
                    <button id="start-timer" class="cute-button bg-pastel-green hover:bg-green-400 text-green-800 font-medium py-2 px-4 rounded-xl">
                        <span class="flex items-center">â–¶ï¸ å¼€å§‹</span>
                    </button>
                    <button id="pause-timer" class="cute-button bg-pastel-yellow hover:bg-yellow-300 text-yellow-800 font-medium py-2 px-4 rounded-xl">
                        <span class="flex items-center">â¸ï¸ æš‚åœ</span>
                    </button>
                    <button id="reset-timer" class="cute-button bg-pastel-pink hover:bg-red-300 text-red-800 font-medium py-2 px-4 rounded-xl">
                        <span class="flex items-center">ğŸ”„ é‡ç½®</span>
                    </button>
                </div>
            </div>
            
            <!-- åŠ åˆ†é¡¹ -->
            <div class="mb-5">
                <h2 class="text-xl font-bold mb-3 text-girl-hotpink dark:text-girl-lightpink flex items-center">
                    <span class="mr-2">âœ¨</span>åŠ åˆ†é¡¹<span class="ml-2">âœ¨</span>
                </h2>
                <div class="grid grid-cols-2 gap-3" id="add-buttons-container">
                    <!-- åŠ åˆ†æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ‰£åˆ†é¡¹ -->
            <div class="mb-5">
                <h2 class="text-xl font-bold mb-3 text-pink-600 dark:text-pink-300 flex items-center">
                    <span class="mr-2">âš ï¸</span>æ‰£åˆ†é¡¹<span class="ml-2">âš ï¸</span>
                </h2>
                <div class="grid grid-cols-2 gap-3" id="deduct-buttons-container">
                    <!-- æ‰£åˆ†æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="py-3 text-center text-girl-hotpink dark:text-girl-lightpink text-sm">
                ğŸŒŸ è”ç³»å¼€å‘è€…å¾®ä¿¡ï¼šQiqiyiyi2023 ğŸŒŸ
            </div>
        </div>
        
        <!-- Tab 2: ç»Ÿè®¡ -->
        <div id="tab2" class="tab-content">
            <div class="mb-6 p-4 rounded-xl glass">
                <h2 class="text-lg font-semibold mb-3 text-girl-hotpink dark:text-girl-lightpink">ä»Šæ—¥æ•°æ®ç»Ÿè®¡</h2>
                <div class="h-64">
                    <canvas id="pointsChart"></canvas>
                </div>
            </div>
            
            <div class="p-4 rounded-xl glass">
                <h2 class="text-lg font-semibold mb-3 text-girl-hotpink dark:text-girl-lightpink">ç§¯åˆ†è®°å½•</h2>
                <div class="log-container">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-2 text-gray-600 dark:text-gray-300 text-sm">æ—¶é—´</th>
                                <th class="text-left py-2 text-gray-600 dark:text-gray-300 text-sm">äº‹é¡¹</th>
                                <th class="text-left py-2 text-gray-600 dark:text-gray-300 text-sm">åˆ†å€¼</th>
                                <th class="text-left py-2 text-gray-600 dark:text-gray-300 text-sm">ç´¯è®¡</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body">
                            <!-- è®°å½•å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: è®¾ç½® -->
        <div id="tab3" class="tab-content">
            <div class="mb-6 p-4 rounded-xl glass">
                <h2 class="text-lg font-semibold mb-3 text-girl-hotpink dark:text-girl-lightpink">åŠ åˆ†é¡¹è®¾ç½®</h2>
                <div id="add-points-settings">
                    <!-- åŠ åˆ†é¡¹è®¾ç½®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button id="add-new-add-item" class="mt-3 px-4 py-2 bg-girl-hotpink text-white rounded-lg shadow-md hover:bg-girl-pink focus:outline-none">
                    æ·»åŠ åŠ åˆ†é¡¹
                </button>
            </div>
            
            <div class="mb-6 p-4 rounded-xl glass">
                <h2 class="text-lg font-semibold mb-3 text-girl-hotpink dark:text-girl-lightpink">æ‰£åˆ†é¡¹è®¾ç½®</h2>
                <div id="deduct-points-settings">
                    <!-- æ‰£åˆ†é¡¹è®¾ç½®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button id="add-new-deduct-item" class="mt-3 px-4 py-2 bg-girl-hotpink text-white rounded-lg shadow-md hover:bg-girl-pink focus:outline-none">
                    æ·»åŠ æ‰£åˆ†é¡¹
                </button>
            </div>
            
            <!-- æ–°å¢ï¼šå¥–å“è®¾ç½® -->
            <div class="mb-6 p-4 rounded-xl glass">
                <h2 class="text-lg font-semibold mb-3 text-girl-hotpink dark:text-girl-lightpink">å¥–å“è®¾ç½®</h2>
                <div id="rewards-settings">
                    <!-- å¥–å“è®¾ç½®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <button id="add-new-reward" class="mt-3 px-4 py-2 bg-girl-hotpink text-white rounded-lg shadow-md hover:bg-girl-pink focus:outline-none">
                    æ·»åŠ æ–°å¥–å“
                </button>
            </div>
            
            <div class="p-4 rounded-xl glass">
                <h2 class="text-lg font-semibold mb-3 text-girl-hotpink dark:text-girl-lightpink">æ•°æ®ç®¡ç†</h2>
                <button id="reset-today-data" class="mr-2 px-4 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 focus:outline-none">
                    é‡ç½®ä»Šæ—¥æ•°æ®
                </button>
            </div>
        </div>
        
        <!-- Tab 4: å¯¼å‡º -->
        <div id="tab4" class="tab-content">
            <div class="p-4 rounded-xl glass">
                <h2 class="text-lg font-semibold mb-3 text-girl-hotpink dark:text-girl-lightpink">æ•°æ®å¯¼å‡º</h2>
                <p class="mb-4 text-gray-600 dark:text-gray-300">å¯¼å‡ºæ•°æ®ä¸º CSV æ ¼å¼ï¼Œå¯ç”¨äºç”µå­è¡¨æ ¼è½¯ä»¶ä¸­æŸ¥çœ‹åˆ†æã€‚</p>
                
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 mb-2">é€‰æ‹©å¯¼å‡ºèŒƒå›´</label>
                    <select id="export-range" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-md">
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month">æœ¬æœˆ</option>
                        <option value="all">å…¨éƒ¨æ•°æ®</option>
                    </select>
                </div>
                
                <button id="export-csv" class="px-4 py-2 bg-girl-hotpink text-white rounded-lg shadow-md hover:bg-girl-pink focus:outline-none">
                    å¯¼å‡º CSV
                </button>
            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨Tabå¯¼èˆª -->
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-md" style="z-index: 1000;">
        <div class="flex justify-around py-3">
            <div class="tab-item flex flex-col items-center cursor-pointer" data-tab="tab1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-girl-hotpink" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <span class="text-xs mt-1">è®°å½•</span>
            </div>
            <div class="tab-item flex flex-col items-center cursor-pointer" data-tab="tab2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span class="text-xs mt-1">ç»Ÿè®¡</span>
            </div>
            <div class="tab-item flex flex-col items-center cursor-pointer" data-tab="tab3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="text-xs mt-1">è®¾ç½®</span>
            </div>
            <div class="tab-item flex flex-col items-center cursor-pointer" data-tab="tab4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span class="text-xs mt-1">å¯¼å‡º</span>
            </div>
        </div>
    </div>
    
    <!-- æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="data-status" class="data-status">æ•°æ®å·²ä¿å­˜</div>
    
    <!-- å…‘æ¢å¥–å“æ¨¡æ€çª—å£ -->
    <div id="rewards-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-girl-hotpink dark:text-girl-lightpink">å¥–å“å…‘æ¢ä¸­å¿ƒ</h2>
                <button id="close-modal" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-2xl">
                    Ã—
                </button>
            </div>
            
            <p class="text-gray-600 dark:text-gray-300 mb-4">
               å½“å‰çš„å°çº¢èŠ±: <span id="modal-flower-count" class="font-bold text-girl-hotpink">0</span>
            </p>
            
            <div class="grid grid-cols-2 gap-4 mb-4" id="rewards-container">
                <!-- å¥–å“å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div id="reward-detail" class="hidden p-4 bg-girl-lavender dark:bg-gray-800 rounded-xl mt-4">
                <h3 id="detail-title" class="text-xl font-bold mb-2 text-girl-hotpink dark:text-girl-lightpink">å¥–å“åç§°</h3>
                <p id="detail-description" class="text-gray-600 dark:text-gray-300 mb-3">å¥–å“æè¿°...</p>
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <span>ä»·æ ¼: </span>
                        <span id="detail-price" class="font-bold text-girl-hotpink ml-1">20</span>
                        <span class="ml-1">ğŸŒº</span>
                    </div>
                    <button id="confirm-exchange" class="bg-gradient-to-r from-girl-pink to-girl-hotpink hover:from-girl-hotpink hover:to-girl-pink text-white font-bold py-2 px-4 rounded-lg">
                        ç¡®è®¤å…‘æ¢
                    </button>
                </div>
            </div>
            
            <!-- å…‘æ¢å†å²è®°å½• -->
            <div id="exchange-history" class="mt-6">
                <h3 class="text-xl font-bold mb-2 text-girl-hotpink dark:text-girl-lightpink">å…‘æ¢å†å²</h3>
                <div class="exchange-history-container overflow-auto max-h-40">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th class="rounded-tl-lg">å¥–å“</th>
                                <th>èŠ±æœµ</th>
                                <th class="rounded-tr-lg">æ—¶é—´</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <!-- å†å²è®°å½•å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                <div id="no-history" class="text-center text-gray-500 py-4">æš‚æ— å…‘æ¢è®°å½•</div>
            </div>
            
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-4 text-center">
                ç‚¹å‡»å¥–å“æŸ¥çœ‹è¯¦æƒ…å¹¶å…‘æ¢
            </p>
        </div>
    </div>
    
    <!-- å…‘æ¢ç»“æœé€šçŸ¥ -->
    <div id="exchange-notification" class="exchange-notification">
        <div class="text-center">
            <div id="notification-icon" class="notification-icon">ğŸ‰</div>
            <div id="notification-message" class="font-bold text-lg">å…‘æ¢æˆåŠŸ!</div>
        </div>
    </div>

    <script>
        // æ£€æµ‹æš—é»‘æ¨¡å¼
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // åˆå§‹åŒ–å˜é‡
        let score = 0;
        let timerInterval = null;
        let seconds = 0;
        let isRunning = false;
        let selectedReward = null;
        let exchangeHistory = [];
        let pointsLog = []; // ç§¯åˆ†å˜åŠ¨è®°å½•
        let addItems = []; // åŠ åˆ†é¡¹åˆ—è¡¨
        let deductItems = []; // æ‰£åˆ†é¡¹åˆ—è¡¨
        let pointsChart = null; // å›¾è¡¨å¯¹è±¡
        let rewards = []; // å¥–å“åˆ—è¡¨
        
        // æœ€å¤§ç§¯åˆ†å€¼
        const MAX_SCORE = 220;
        
        // æœ¬åœ°å­˜å‚¨é”®å
        const STORAGE_KEY = 'maggie_flower_data';
        const dataStatusEl = document.getElementById('data-status');
        
        // å¢å¼ºçš„å­˜å‚¨ç³»ç»Ÿï¼Œå¤„ç†å¤šç§æµè§ˆå™¨ç¯å¢ƒ
        const storageSystem = {
            // æ£€æµ‹å­˜å‚¨å¯ç”¨æ€§
            isLocalStorageAvailable: function() {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    return true;
                } catch (e) {
                    return false;
                }
            },
            
            isSessionStorageAvailable: function() {
                try {
                    sessionStorage.setItem('test', 'test');
                    sessionStorage.removeItem('test');
                    return true;
                } catch (e) {
                    return false;
                }
            },
            
            // Cookiesä½œä¸ºå¤‡é€‰å­˜å‚¨æ–¹å¼
            setCookie: function(name, value, days) {
                let expires = "";
                if (days) {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + expires + "; path=/";
            },
            
            getCookie: function(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) {
                        try {
                            return JSON.parse(decodeURIComponent(c.substring(nameEQ.length, c.length)));
                        } catch (e) {
                            return null;
                        }
                    }
                }
                return null;
            },
            
            // ä¿å­˜æ•°æ®ï¼Œå°è¯•å¤šç§å­˜å‚¨æ–¹å¼
            saveData: function(key, data) {
                let savedSuccessfully = false;
                
                // å°è¯•ä½¿ç”¨localStorage
                if (this.isLocalStorageAvailable()) {
                    try {
                        localStorage.setItem(key, JSON.stringify(data));
                        savedSuccessfully = true;
                        showDataStatus("æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°");
                    } catch (e) {
                        console.warn("localStorageä¿å­˜å¤±è´¥", e);
                    }
                }
                
                // å¦‚æœlocalStorageå¤±è´¥ï¼Œå°è¯•sessionStorage
                if (!savedSuccessfully && this.isSessionStorageAvailable()) {
                    try {
                        sessionStorage.setItem(key, JSON.stringify(data));
                        savedSuccessfully = true;
                        showDataStatus("æ•°æ®å·²ä¿å­˜åˆ°ä¼šè¯");
                    } catch (e) {
                        console.warn("sessionStorageä¿å­˜å¤±è´¥", e);
                    }
                }
                
                // å¦‚æœä»¥ä¸Šéƒ½å¤±è´¥ï¼Œä½¿ç”¨Cookie
                if (!savedSuccessfully) {
                    try {
                        this.setCookie(key, data, 30); // 30å¤©æœ‰æ•ˆæœŸ
                        savedSuccessfully = true;
                        showDataStatus("æ•°æ®å·²ä¿å­˜åˆ°Cookie");
                    } catch (e) {
                        console.error("æ‰€æœ‰å­˜å‚¨æ–¹å¼éƒ½å¤±è´¥", e);
                        showDataStatus("æ•°æ®ä¿å­˜å¤±è´¥", true);
                    }
                }
                
                return savedSuccessfully;
            },
            
            // åŠ è½½æ•°æ®ï¼Œå°è¯•å¤šç§å­˜å‚¨æ–¹å¼
            loadData: function(key) {
                let data = null;
                
                // å°è¯•ä»localStorageåŠ è½½
                if (this.isLocalStorageAvailable()) {
                    try {
                        const storedData = localStorage.getItem(key);
                        if (storedData) {
                            data = JSON.parse(storedData);
                            showDataStatus("ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®");
                        }
                    } catch (e) {
                        console.warn("ä»localStorageåŠ è½½å¤±è´¥", e);
                    }
                }
                
                // å¦‚æœlocalStorageæ²¡æœ‰æ•°æ®ï¼Œå°è¯•sessionStorage
                if (!data && this.isSessionStorageAvailable()) {
                    try {
                        const storedData = sessionStorage.getItem(key);
                        if (storedData) {
                            data = JSON.parse(storedData);
                            showDataStatus("ä»ä¼šè¯å­˜å‚¨åŠ è½½æ•°æ®");
                        }
                    } catch (e) {
                        console.warn("ä»sessionStorageåŠ è½½å¤±è´¥", e);
                    }
                }
                
                // å¦‚æœä»¥ä¸Šéƒ½æ²¡æœ‰æ•°æ®ï¼Œå°è¯•Cookie
                if (!data) {
                    try {
                        data = this.getCookie(key);
                        if (data) {
                            showDataStatus("ä»CookieåŠ è½½æ•°æ®");
                        }
                    } catch (e) {
                        console.warn("ä»CookieåŠ è½½å¤±è´¥", e);
                    }
                }
                
                if (!data) {
                    showDataStatus("æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ•°æ®", true);
                }
                
                return data;
            }
        };
        
        // é»˜è®¤å¥–å“åˆ—è¡¨
        const DEFAULT_REWARDS = [
            { id: 1, name: 'ç³–æœ', emoji: 'ğŸ¬', description: 'ç¾å‘³çš„ç³–æœï¼Œå°å°çš„ç”œèœœï¼', price: 25 },
            { id: 2, name: 'åŠ¨ç”»ç‰‡20åˆ†é’Ÿ', emoji: 'ğŸ“º', description: 'çœ‹20åˆ†é’Ÿä½ æœ€å–œæ¬¢çš„åŠ¨ç”»ç‰‡ï¼', price: 50 },
            { id: 3, name: 'é¥®æ–™', emoji: 'ğŸ¥¤', description: 'å¥½å–çš„é¥®æ–™ï¼Œè§£æ¸´åˆç¾å‘³ï¼', price: 70 },
            { id: 4, name: 'å†°æ·‡æ·‹', emoji: 'ğŸ¦', description: 'ç¾å‘³çš„å†°æ·‡æ·‹ï¼Œç”œèœœæ¸…å‡‰çš„äº«å—ï¼', price: 100 },
            { id: 5, name: 'æ—‹è½¬æœ¨é©¬', emoji: 'ğŸ ', description: 'åæ—‹è½¬æœ¨é©¬ï¼Œç«¥è¯èˆ¬çš„ç¾å¥½ä½“éªŒï¼', price: 150 },
            { id: 6, name: 'æ±‰å ¡', emoji: 'ğŸ”', description: 'ç¾å‘³çš„æ±‰å ¡ï¼Œå¤§å¤§çš„æ»¡è¶³ï¼', price: 200 }
        ];
        
        // é»˜è®¤åŠ åˆ†é¡¹
        const DEFAULT_ADD_ITEMS = [
            { name: "åå§¿ç«¯æ­£", points: 2, emoji: "ğŸ§â€â™€ï¸" },
            { name: "å›ç­”æ­£ç¡®", points: 1, emoji: "âœ…" },
            { name: "ä¸“å¿ƒå­¦ä¹ ", points: 3, emoji: "ğŸ“š" },
            { name: "å®Œæˆä½œä¸š", points: 5, emoji: "ğŸ‰" }
        ];
        
        // é»˜è®¤æ‰£åˆ†é¡¹
        const DEFAULT_DEDUCT_ITEMS = [
            { name: "åå§¿ä¸ç«¯æ­£", points: -1, emoji: "ğŸ˜–" },
            { name: "èµ°ç¥", points: -2, emoji: "ğŸ™„" },
            { name: "åšå…¶ä»–äº‹æƒ…", points: -3, emoji: "ğŸ®" },
            { name: "æ‹’ç»å®Œæˆ", points: -5, emoji: "âŒ" }
        ];
        
        // è·å–DOMå…ƒç´ 
        const totalScoreEl = document.getElementById('total-score');
        const timerEl = document.getElementById('timer');
        const startBtn = document.getElementById('start-timer');
        const pauseBtn = document.getElementById('pause-timer');
        const resetBtn = document.getElementById('reset-timer');
        const progressBar = document.getElementById('flower-progress-bar');
        const addButtonsContainer = document.getElementById('add-buttons-container');
        const deductButtonsContainer = document.getElementById('deduct-buttons-container');
        
        // å…‘æ¢å¥–å“ç›¸å…³å…ƒç´ 
        const rewardsModal = document.getElementById('rewards-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const exchangeBtn = document.getElementById('exchange-button');
        const rewardsContainer = document.getElementById('rewards-container');
        const modalFlowerCount = document.getElementById('modal-flower-count');
        const rewardDetail = document.getElementById('reward-detail');
        const detailTitle = document.getElementById('detail-title');
        const detailDescription = document.getElementById('detail-description');
        const detailPrice = document.getElementById('detail-price');
        const confirmExchangeBtn = document.getElementById('confirm-exchange');
        const exchangeNotification = document.getElementById('exchange-notification');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationMessage = document.getElementById('notification-message');
        const historyTableBody = document.getElementById('history-table-body');
        const noHistoryMessage = document.getElementById('no-history');
        
        // ç»Ÿè®¡é¡µé¢ç›¸å…³å…ƒç´ 
        const logTableBody = document.getElementById('log-table-body');
        
        // è®¾ç½®é¡µé¢ç›¸å…³å…ƒç´ 
        const addPointsSettings = document.getElementById('add-points-settings');
        const deductPointsSettings = document.getElementById('deduct-points-settings');
        const rewardsSettings = document.getElementById('rewards-settings');
        const addNewAddItemBtn = document.getElementById('add-new-add-item');
        const addNewDeductItemBtn = document.getElementById('add-new-deduct-item');
        const addNewRewardBtn = document.getElementById('add-new-reward');
        const resetTodayDataBtn = document.getElementById('reset-today-data');
        
        // å¯¼å‡ºé¡µé¢ç›¸å…³å…ƒç´ 
        const exportRangeSelect = document.getElementById('export-range');
        const exportCsvBtn = document.getElementById('export-csv');
        
        // æ ‡ç­¾å¯¼èˆªç›¸å…³å…ƒç´ 
        const tabItems = document.querySelectorAll('.tab-item');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // æ˜¾ç¤ºæ•°æ®å­˜å‚¨çŠ¶æ€
        function showDataStatus(message, isError = false) {
            dataStatusEl.textContent = message;
            dataStatusEl.style.color = isError ? '#F44336' : '#FF5C8D';
            dataStatusEl.classList.add('show');
            
            setTimeout(() => {
                dataStatusEl.classList.remove('show');
            }, 2000);
        }
        
        // æ ‡ç­¾åˆ‡æ¢
        function setupTabs() {
            tabItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // æ›´æ–°æ ‡ç­¾å¤–è§‚
                    tabItems.forEach(tab => {
                        const svg = tab.querySelector('svg');
                        if (tab === this) {
                            svg.classList.remove('text-gray-500');
                            svg.classList.add('text-girl-hotpink');
                        } else {
                            svg.classList.remove('text-girl-hotpink');
                            svg.classList.add('text-gray-500');
                        }
                    });
                    
                    // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
                    tabContents.forEach(content => {
                        if (content.id === tabId) {
                            content.classList.add('active');
                            
                            // å¦‚æœåˆ‡æ¢åˆ°ç»Ÿè®¡æ ‡ç­¾ï¼Œæ›´æ–°å›¾è¡¨
                            if (tabId === 'tab2') {
                                updateStatistics();
                                updateLogTable();
                            }
                            
                            // å¦‚æœåˆ‡æ¢åˆ°è®¾ç½®æ ‡ç­¾ï¼Œæ›´æ–°è®¾ç½®UI
                            if (tabId === 'tab3') {
                                updateSettingsUI();
                            }
                        } else {
                            content.classList.remove('active');
                        }
                    });
                });
            });
        }
        
        // æœ¬åœ°å­˜å‚¨ç›¸å…³æ–¹æ³•
        function saveData() {
            const data = {
                score: score,
                seconds: seconds,
                isRunning: isRunning,
                exchangeHistory: exchangeHistory,
                pointsLog: pointsLog,
                addItems: addItems,
                deductItems: deductItems,
                rewards: rewards,
                lastSaved: new Date().getTime()
            };
            
            try {
                storageSystem.saveData(STORAGE_KEY, data);
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                showDataStatus('ä¿å­˜æ•°æ®å¤±è´¥', true);
            }
        }
        
        function loadData() {
            try {
                const data = storageSystem.loadData(STORAGE_KEY);
                
                if (data) {
                    // æ¢å¤åˆ†æ•°
                    score = data.score || 0;
                    
                    // æ¢å¤è®¡æ—¶å™¨çŠ¶æ€
                    seconds = data.seconds || 0;
                    timerEl.textContent = formatTime(seconds);
                    
                    // æ¢å¤æ˜¯å¦æ­£åœ¨è®¡æ—¶
                    if (data.isRunning) {
                        startTimer(false); // ä¸è¦å†æ¬¡ä¿å­˜ï¼Œé˜²æ­¢å¾ªç¯
                    }
                    
                    // æ¢å¤å…‘æ¢å†å²
                    exchangeHistory = data.exchangeHistory || [];
                    
                    // æ¢å¤ç§¯åˆ†è®°å½•
                    pointsLog = data.pointsLog || [];
                    
                    // æ¢å¤åŠ åˆ†é¡¹å’Œæ‰£åˆ†é¡¹è®¾ç½®
                    addItems = data.addItems || DEFAULT_ADD_ITEMS;
                    deductItems = data.deductItems || DEFAULT_DEDUCT_ITEMS;
                    
                    // æ¢å¤å¥–å“è®¾ç½®
                    rewards = data.rewards || DEFAULT_REWARDS;
                    
                    // æ˜¾ç¤ºä¸Šæ¬¡ä¿å­˜æ—¶é—´
                    if (data.lastSaved) {
                        const lastSavedDate = new Date(data.lastSaved);
                        const timeStr = lastSavedDate.toLocaleTimeString();
                        showDataStatus(`æ•°æ®å·²æ¢å¤ (${timeStr})`);
                    } else {
                        showDataStatus('æ•°æ®å·²æ¢å¤');
                    }
                    
                    console.log('æ•°æ®å·²åŠ è½½', data);
                } else {
                    // åˆå§‹åŒ–é»˜è®¤å€¼
                    addItems = DEFAULT_ADD_ITEMS;
                    deductItems = DEFAULT_DEDUCT_ITEMS;
                    rewards = DEFAULT_REWARDS;
                    console.log('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                }
                
                // æ›´æ–°UI
                updateScoreDisplay(false);
                updatePointButtons();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showDataStatus('åŠ è½½æ•°æ®å¤±è´¥', true);
                
                // åˆå§‹åŒ–é»˜è®¤å€¼
                addItems = DEFAULT_ADD_ITEMS;
                deductItems = DEFAULT_DEDUCT_ITEMS;
                rewards = DEFAULT_REWARDS;
                updatePointButtons();
                updateScoreDisplay(false);
            }
        }
        
        // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
        function updateScoreDisplay(shouldSave = true) {
            totalScoreEl.textContent = score;
            totalScoreEl.classList.add('bounce');
            setTimeout(() => {
                totalScoreEl.classList.remove('bounce');
            }, 500);
            modalFlowerCount.textContent = score;
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgressBar();
            
            if (shouldSave) {
                saveData();
            }
        }
        
        // æ›´æ–°è¿›åº¦æ¡å’Œé‡Œç¨‹ç¢‘
        function updateProgressBar() {
            // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”ï¼Œæœ€å¤§ä¸º100%
            const percent = Math.min(100, (score / MAX_SCORE) * 100);
            progressBar.style.width = `${percent}%`;
            
            // æ¸…é™¤ç°æœ‰æ ‡è®°ç‚¹
            const existingMarkers = document.querySelectorAll('.progress-marker');
            existingMarkers.forEach(marker => marker.remove());
            
            // æ·»åŠ å¥–å“é‡Œç¨‹ç¢‘
            const progressContainer = document.querySelector('.progress-container');
            
            rewards.forEach(reward => {
                // åªæ˜¾ç¤ºå°äºæˆ–ç­‰äºæœ€å¤§åˆ†æ•°çš„é‡Œç¨‹ç¢‘
                if (reward.price <= MAX_SCORE) {
                    // è®¡ç®—ä½ç½®ç™¾åˆ†æ¯”
                    const markerPercent = (reward.price / MAX_SCORE) * 100;
                    
                    // åˆ›å»ºæ ‡è®°ç‚¹
                    const marker = document.createElement('div');
                    marker.className = 'progress-marker';
                    marker.style.left = `${markerPercent}%`;
                    
                    // ä¸ºå·²è¾¾åˆ°çš„é‡Œç¨‹ç¢‘æ·»åŠ ä¸åŒçš„æ ·å¼
                    const isReached = score >= reward.price;
                    
                    marker.innerHTML = `
                        <div class="progress-marker-icon ${isReached ? 'opacity-100' : 'opacity-50'}">${reward.emoji}</div>
                        <div class="progress-marker-label">${reward.price}</div>
                    `;
                    
                    progressContainer.appendChild(marker);
                }
            });
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const secs = totalSeconds % 60;
            
            return [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                secs.toString().padStart(2, '0')
            ].join(':');
        }
        
        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            seconds++;
            timerEl.textContent = formatTime(seconds);
            saveData();
        }
        
        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer(shouldSave = true) {
            if (!isRunning) {
                isRunning = true;
                timerInterval = setInterval(updateTimer, 1000);
                startBtn.classList.add('bg-opacity-50');
                pauseBtn.classList.remove('bg-opacity-50');
                
                if (shouldSave) {
                    saveData();
                }
            }
        }
        
        // æš‚åœè®¡æ—¶å™¨
        function pauseTimer() {
            if (isRunning) {
                isRunning = false;
                clearInterval(timerInterval);
                pauseBtn.classList.add('bg-opacity-50');
                startBtn.classList.remove('bg-opacity-50');
                saveData();
            }
        }
        
        // é‡ç½®è®¡æ—¶å™¨
        function resetTimer() {
            pauseTimer();
            seconds = 0;
            timerEl.textContent = formatTime(seconds);
            saveData();
        }
        
        // æ˜¾ç¤ºåˆ†æ•°å˜åŒ–åŠ¨ç”»
        function showScoreChange(button, points) {
            const scoreChange = document.createElement('div');
            scoreChange.className = 'score-change';
            scoreChange.textContent = points > 0 ? `+${points}` : points;
            scoreChange.style.color = points > 0 ? '#FF5C8D' : '#F44336';
            
            button.parentElement.appendChild(scoreChange);
            
            // å®šä½åœ¨æŒ‰é’®ä¸Šæ–¹ä¸­å¤®
            const buttonRect = button.getBoundingClientRect();
            
            scoreChange.style.left = `${buttonRect.width / 2 - scoreChange.offsetWidth / 2}px`;
            scoreChange.style.top = `${-scoreChange.offsetHeight}px`;
            
            // ç§»é™¤å…ƒç´ 
            setTimeout(() => {
                scoreChange.remove();
            }, 1000);
        }
        
        // æ‰“å¼€å¥–å“æ¨¡æ€çª—å£
        function openRewardsModal() {
            rewardsModal.classList.add('show');
            modalFlowerCount.textContent = score;
            renderRewards();
            updateExchangeHistory();
        }
        
        // å…³é—­å¥–å“æ¨¡æ€çª—å£
        function closeRewardsModal() {
            rewardsModal.classList.remove('show');
            rewardDetail.classList.add('hidden');
            selectedReward = null;
            
            // ç§»é™¤é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.reward-item').forEach(item => {
                item.classList.remove('selected');
            });
        }
        
        // æ¸²æŸ“å¥–å“åˆ—è¡¨
        function renderRewards() {
            rewardsContainer.innerHTML = '';
            
            // æŒ‰ç§¯åˆ†æ’åº
            const sortedRewards = [...rewards].sort((a, b) => a.price - b.price);
            
            sortedRewards.forEach(reward => {
                const rewardItem = document.createElement('div');
                rewardItem.className = 'reward-item rounded-xl p-3 bg-white dark:bg-gray-700 shadow-md';
                rewardItem.dataset.id = reward.id;
                
                rewardItem.innerHTML = `
                    <div class="reward-image mb-2">${reward.emoji}</div>
                    <h3 class="font-bold text-gray-800 dark:text-gray-100 text-center mb-1">${reward.name}</h3>
                    <div class="reward-price justify-center">
                        <span>${reward.price}</span>
                        <span class="flower">ğŸŒº</span>
                    </div>
                `;
                
                rewardItem.addEventListener('click', () => {
                    selectReward(reward);
                });
                
                rewardsContainer.appendChild(rewardItem);
            });
        }
        
        // é€‰æ‹©å¥–å“
        function selectReward(reward) {
            // ç§»é™¤å…¶ä»–é¡¹çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.reward-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å½“å‰é¡¹
            const selectedItem = document.querySelector(`.reward-item[data-id="${reward.id}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // æ›´æ–°è¯¦æƒ…åŒºåŸŸ
            selectedReward = reward;
            detailTitle.textContent = reward.name;
            detailDescription.textContent = reward.description;
            detailPrice.textContent = reward.price;
            
            // æ˜¾ç¤ºè¯¦æƒ…åŒºåŸŸ
            rewardDetail.classList.remove('hidden');
        }
        
        // æ›´æ–°å…‘æ¢å†å²è®°å½•
        function updateExchangeHistory() {
            historyTableBody.innerHTML = '';
            
            if (exchangeHistory.length === 0) {
                noHistoryMessage.style.display = 'block';
                return;
            }
            
            noHistoryMessage.style.display = 'none';
            
            // æŒ‰ç…§æ—¶é—´å€’åºæ’åˆ—
            const sortedHistory = [...exchangeHistory].reverse();
            
            sortedHistory.forEach(record => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.innerHTML = `${record.emoji} ${record.name}`;
                
                const priceCell = document.createElement('td');
                priceCell.innerHTML = `${record.price} <span class="flower">ğŸŒº</span>`;
                
                const dateCell = document.createElement('td');
                const date = new Date(record.timestamp);
                dateCell.textContent = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                
                row.appendChild(nameCell);
                row.appendChild(priceCell);
                row.appendChild(dateCell);
                
                historyTableBody.appendChild(row);
            });
        }
        
        // ç¡®è®¤å…‘æ¢å¥–å“
        function confirmExchange() {
            if (!selectedReward) return;
            
            if (score >= selectedReward.price) {
                // æ‰£å‡åˆ†æ•°
                score -= selectedReward.price;
                
                // æ·»åŠ åˆ°ç§¯åˆ†è®°å½•
                const now = new Date();
                pointsLog.push({
                    time: now.toISOString(),
                    item: `å…‘æ¢å¥–å“: ${selectedReward.name}`,
                    points: -selectedReward.price,
                    totalPoints: score
                });
                
                updateScoreDisplay();
                
                // æ·»åŠ åˆ°å…‘æ¢å†å²
                const exchange = {
                    id: selectedReward.id,
                    name: selectedReward.name,
                    emoji: selectedReward.emoji,
                    price: selectedReward.price,
                    timestamp: now.getTime()
                };
                
                exchangeHistory.push(exchange);
                updateExchangeHistory();
                saveData();
                
                // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
                showExchangeNotification(true, `æˆåŠŸå…‘æ¢ ${selectedReward.name}ï¼`);
                
                // å…³é—­æ¨¡æ€çª—å£
                setTimeout(() => {
                    closeRewardsModal();
                }, 500);
            } else {
                // ä½™é¢ä¸è¶³ï¼Œæ˜¾ç¤ºé”™è¯¯
                showExchangeNotification(false, `å°çº¢èŠ±ä¸è¶³ï¼Œè¿˜éœ€è¦ ${selectedReward.price - score} æœµå°çº¢èŠ±`);
                
                // æ˜¾ç¤ºåˆ†æ•°æŠ–åŠ¨åŠ¨ç”»
                modalFlowerCount.classList.add('shake');
                setTimeout(() => {
                    modalFlowerCount.classList.remove('shake');
                }, 500);
            }
        }
        
        // æ˜¾ç¤ºå…‘æ¢é€šçŸ¥
        function showExchangeNotification(success, message) {
            notificationIcon.textContent = success ? 'ğŸ‰' : 'â—';
            notificationMessage.textContent = message;
            exchangeNotification.style.display = 'block';
            exchangeNotification.classList.add('success-animation');
            
            setTimeout(() => {
                exchangeNotification.classList.remove('success-animation');
                exchangeNotification.style.display = 'none';
            }, 2000);
        }
        
        // æ›´æ–°ç§¯åˆ†æŒ‰é’®
        function updatePointButtons() {
            if (!addButtonsContainer || !deductButtonsContainer) return;
            
            // æ¸…ç©ºå®¹å™¨
            addButtonsContainer.innerHTML = '';
            deductButtonsContainer.innerHTML = '';
            
            // æ·»åŠ åŠ åˆ†æŒ‰é’®
            addItems.forEach((item) => {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-container';
                
                const button = document.createElement('button');
                button.dataset.points = item.points;
                button.className = 'add-button w-full bg-gradient-to-br from-green-400 to-green-500 hover:from-green-500 hover:to-green-600 text-white font-medium py-3 px-4 rounded-xl';
                button.innerHTML = `<span class="flex items-center justify-center">${item.emoji} ${item.name} +${item.points}</span>`;
                
                button.addEventListener('click', () => {
                    addPoints(item, button);
                });
                
                buttonContainer.appendChild(button);
                addButtonsContainer.appendChild(buttonContainer);
            });
            
            // æ·»åŠ æ‰£åˆ†æŒ‰é’®
            deductItems.forEach((item) => {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-container';
                
                const button = document.createElement('button');
                button.dataset.points = item.points;
                button.className = 'add-button w-full bg-gradient-to-br from-pink-400 to-pink-500 hover:from-pink-500 hover:to-pink-600 text-white font-medium py-3 px-4 rounded-xl';
                button.innerHTML = `<span class="flex items-center justify-center">${item.emoji} ${item.name} ${item.points}</span>`;
                
                button.addEventListener('click', () => {
                    deductPoints(item, button);
                });
                
                buttonContainer.appendChild(button);
                deductButtonsContainer.appendChild(buttonContainer);
            });
        }
        
        // æ·»åŠ ç§¯åˆ†
        function addPoints(item, button) {
            score += item.points;
            
            // è®°å½•åˆ°ç§¯åˆ†æ—¥å¿—
            const now = new Date();
            pointsLog.push({
                time: now.toISOString(),
                item: item.name,
                points: item.points,
                totalPoints: score
            });
            
            showScoreChange(button, item.points);
            
            // æ·»åŠ æŒ‰é’®åŠ¨ç”»
            button.classList.add('scale-95');
            setTimeout(() => {
                button.classList.remove('scale-95');
            }, 200);
            
            updateScoreDisplay();
        }
        
        // æ‰£å‡ç§¯åˆ†
        function deductPoints(item, button) {
            score += item.points; // æ³¨æ„æ‰£åˆ†é¡¹çš„åˆ†æ•°æ˜¯è´Ÿæ•°
            
            // è®°å½•åˆ°ç§¯åˆ†æ—¥å¿—
            const now = new Date();
            pointsLog.push({
                time: now.toISOString(),
                item: item.name,
                points: item.points,
                totalPoints: score
            });
            
            showScoreChange(button, item.points);
            
            // æ·»åŠ æŒ‰é’®åŠ¨ç”»
            button.classList.add('scale-95');
            setTimeout(() => {
                button.classList.remove('scale-95');
            }, 200);
            
            updateScoreDisplay();
        }
        
        // æ›´æ–°ç§¯åˆ†è®°å½•è¡¨
        function updateLogTable() {
            const tableBody = document.getElementById('log-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedLog = [...pointsLog].sort((a, b) => new Date(b.time) - new Date(a.time));
            
            sortedLog.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                
                const logTime = new Date(log.time);
                const timeStr = `${logTime.getHours().toString().padStart(2, '0')}:${logTime.getMinutes().toString().padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td class="py-2">${timeStr}</td>
                    <td class="py-2">${log.item}</td>
                    <td class="py-2 ${log.points > 0 ? 'text-green-500' : 'text-red-500'}">${log.points > 0 ? '+' + log.points : log.points}</td>
                    <td class="py-2">${log.totalPoints}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡å›¾è¡¨
        function updateStatistics() {
            const ctx = document.getElementById('pointsChart');
            if (!ctx) return;
            
            // å¤„ç†å›¾è¡¨æ•°æ®
            const hourlyData = processHourlyData();
            
            // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œé”€æ¯å®ƒ
            if (pointsChart) {
                pointsChart.destroy();
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨
            pointsChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: hourlyData.hours,
                    datasets: [
                        {
                            label: 'ç´¯è®¡ç§¯åˆ†',
                            data: hourlyData.totalPoints,
                            borderColor: '#FF5C8D',
                            backgroundColor: 'rgba(255, 92, 141, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ç´¯è®¡åŠ åˆ†',
                            data: hourlyData.addPoints,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ç´¯è®¡æ‰£åˆ†',
                            data: hourlyData.deductPoints,
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // å¤„ç†æ¯å°æ—¶æ•°æ®ç”¨äºå›¾è¡¨
        function processHourlyData() {
            const hours = [];
            const addPoints = [];
            const deductPoints = [];
            const totalPoints = [];
            
            // ç”Ÿæˆå°æ—¶æ ‡ç­¾
            for (let h = 0; h < 24; h++) {
                hours.push(`${h}:00`);
                
                // åˆå§‹åŒ–ä¸ºé›¶
                addPoints.push(0);
                deductPoints.push(0);
                totalPoints.push(0);
            }
            
            // å¤„ç†æ—¥å¿—æ•°æ®
            pointsLog.forEach(log => {
                const logTime = new Date(log.time);
                const logHour = logTime.getHours();
                
                if (log.points > 0) {
                    addPoints[logHour] += log.points;
                } else {
                    deductPoints[logHour] += Math.abs(log.points);
                }
            });
            
            // è®¡ç®—ç´¯è®¡æ€»åˆ†
            let runningTotal = 0;
            for (let h = 0; h < 24; h++) {
                runningTotal += (addPoints[h] - deductPoints[h]);
                totalPoints[h] = runningTotal;
            }
            
            return { hours, addPoints, deductPoints, totalPoints };
        }
        
        // æ›´æ–°è®¾ç½®UI
        function updateSettingsUI() {
            updateAddDeductSettings();
            updateRewardsSettings();
        }
        
        // æ›´æ–°åŠ åˆ†æ‰£åˆ†è®¾ç½®
        function updateAddDeductSettings() {
            if (!addPointsSettings || !deductPointsSettings) return;
            
            // æ¸…ç©ºå®¹å™¨
            addPointsSettings.innerHTML = '';
            deductPointsSettings.innerHTML = '';
            
            // åŠ åˆ†é¡¹è®¾ç½®
            addItems.forEach((item, index) => {
                const settingItem = document.createElement('div');
                settingItem.className = 'setting-item flex items-center mb-3';
                settingItem.innerHTML = `
                    <div class="flex-grow mr-2">
                        <div class="flex mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-l-md text-base" 
                                value="${item.name}" placeholder="é¡¹ç›®åç§°" id="add-name-${index}">
                            <input type="text" class="w-10 p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 border-l-0 text-base text-center"
                                value="${item.emoji}" placeholder="ğŸ®" id="add-emoji-${index}">
                        </div>
                        <div class="flex">
                            <input type="number" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-l-md text-base" 
                                value="${item.points}" placeholder="åˆ†å€¼" id="add-points-${index}" min="1">
                            <span class="bg-gray-100 dark:bg-gray-700 p-2 border border-gray-300 dark:border-gray-600 border-l-0 rounded-r-md">åˆ†</span>
                        </div>
                    </div>
                    <button class="delete-add-btn px-3 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 focus:outline-none" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                addPointsSettings.appendChild(settingItem);
                
                const nameInput = document.getElementById(`add-name-${index}`);
                const emojiInput = document.getElementById(`add-emoji-${index}`);
                const pointsInput = document.getElementById(`add-points-${index}`);
                
                nameInput.addEventListener('change', () => {
                    addItems[index].name = nameInput.value;
                    saveData();
                    updatePointButtons();
                });
                
                emojiInput.addEventListener('change', () => {
                    addItems[index].emoji = emojiInput.value;
                    saveData();
                    updatePointButtons();
                });
                
                pointsInput.addEventListener('change', () => {
                    addItems[index].points = Math.max(1, parseInt(pointsInput.value) || 1);
                    saveData();
                    updatePointButtons();
                });
                
                settingItem.querySelector('.delete-add-btn').addEventListener('click', () => {
                    addItems.splice(index, 1);
                    saveData();
                    updateSettingsUI();
                    updatePointButtons();
                });
            });
            
            // æ‰£åˆ†é¡¹è®¾ç½®
            deductItems.forEach((item, index) => {
                const settingItem = document.createElement('div');
                settingItem.className = 'setting-item flex items-center mb-3';
                settingItem.innerHTML = `
                    <div class="flex-grow mr-2">
                        <div class="flex mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-l-md text-base" 
                                value="${item.name}" placeholder="é¡¹ç›®åç§°" id="deduct-name-${index}">
                            <input type="text" class="w-10 p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 border-l-0 text-base text-center"
                                value="${item.emoji}" placeholder="ğŸ®" id="deduct-emoji-${index}">
                        </div>
                        <div class="flex">
                            <input type="number" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-l-md text-base" 
                                value="${Math.abs(item.points)}" placeholder="åˆ†å€¼" id="deduct-points-${index}" min="1">
                            <span class="bg-gray-100 dark:bg-gray-700 p-2 border border-gray-300 dark:border-gray-600 border-l-0 rounded-r-md">åˆ†</span>
                        </div>
                    </div>
                    <button class="delete-deduct-btn px-3 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 focus:outline-none" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                deductPointsSettings.appendChild(settingItem);
                
                const nameInput = document.getElementById(`deduct-name-${index}`);
                const emojiInput = document.getElementById(`deduct-emoji-${index}`);
                const pointsInput = document.getElementById(`deduct-points-${index}`);
                
                nameInput.addEventListener('change', () => {
                    deductItems[index].name = nameInput.value;
                    saveData();
                    updatePointButtons();
                });
                
                emojiInput.addEventListener('change', () => {
                    deductItems[index].emoji = emojiInput.value;
                    saveData();
                    updatePointButtons();
                });
                
                pointsInput.addEventListener('change', () => {
                    deductItems[index].points = -Math.max(1, parseInt(pointsInput.value) || 1);
                    saveData();
                    updatePointButtons();
                });
                
                settingItem.querySelector('.delete-deduct-btn').addEventListener('click', () => {
                    deductItems.splice(index, 1);
                    saveData();
                    updateSettingsUI();
                    updatePointButtons();
                });
            });
        }
        
        // æ›´æ–°å¥–å“è®¾ç½®
        function updateRewardsSettings() {
            if (!rewardsSettings) return;
            
            // æ¸…ç©ºå®¹å™¨
            rewardsSettings.innerHTML = '';
            
            // æŒ‰ç§¯åˆ†æ’åº
            const sortedRewards = [...rewards].sort((a, b) => a.price - b.price);
            
            // å¥–å“è®¾ç½®é¡¹
            sortedRewards.forEach((reward, index) => {
                const settingItem = document.createElement('div');
                settingItem.className = 'setting-item flex flex-col mb-3';
                settingItem.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-girl-hotpink dark:text-girl-lightpink">${reward.name}</h3>
                        <button class="delete-reward-btn px-2 py-1 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 focus:outline-none" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <div>
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">è¡¨æƒ…ç¬¦å·</label>
                            <input type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-md text-base" 
                                value="${reward.emoji}" placeholder="ğŸ®" id="reward-emoji-${index}">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">å¥–å“åç§°</label>
                            <input type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-md text-base" 
                                value="${reward.name}" placeholder="å¥–å“åç§°" id="reward-name-${index}">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">æè¿°</label>
                        <input type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-md text-base" 
                            value="${reward.description}" placeholder="å¥–å“æè¿°" id="reward-description-${index}">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">æ‰€éœ€ç§¯åˆ†</label>
                        <div class="flex">
                            <input type="number" class="w-full p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-l-md text-base" 
                                value="${reward.price}" placeholder="ç§¯åˆ†" id="reward-price-${index}" min="1" max="${MAX_SCORE}">
                            <span class="bg-gray-100 dark:bg-gray-700 p-2 border border-gray-300 dark:border-gray-600 border-l-0 rounded-r-md">ğŸŒº</span>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°å®¹å™¨
                rewardsSettings.appendChild(settingItem);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                const emojiInput = document.getElementById(`reward-emoji-${index}`);
                const nameInput = document.getElementById(`reward-name-${index}`);
                const descriptionInput = document.getElementById(`reward-description-${index}`);
                const priceInput = document.getElementById(`reward-price-${index}`);
                
                emojiInput.addEventListener('change', () => {
                    rewards[index].emoji = emojiInput.value;
                    saveData();
                    updateProgressBar();
                });
                
                nameInput.addEventListener('change', () => {
                    rewards[index].name = nameInput.value;
                    saveData();
                });
                
                descriptionInput.addEventListener('change', () => {
                    rewards[index].description = descriptionInput.value;
                    saveData();
                });
                
                priceInput.addEventListener('change', () => {
                    // ç¡®ä¿ä»·æ ¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
                    const price = Math.min(MAX_SCORE, Math.max(1, parseInt(priceInput.value) || 1));
                    rewards[index].price = price;
                    priceInput.value = price; // æ›´æ–°è¾“å…¥æ¡†å€¼ä»¥åæ˜ ä»»ä½•è¢«é™åˆ¶çš„å€¼
                    saveData();
                    updateProgressBar();
                });
                
                // åˆ é™¤æŒ‰é’®
                settingItem.querySelector('.delete-reward-btn').addEventListener('click', () => {
                    rewards.splice(index, 1);
                    saveData();
                    updateRewardsSettings();
                    updateProgressBar();
                });
            });
        }
        
        // æ·»åŠ æ–°åŠ åˆ†é¡¹
        function addNewAddItem() {
            addItems.push({ name: "æ–°åŠ åˆ†é¡¹", points: 1, emoji: "âœ¨" });
            saveData();
            updateSettingsUI();
            updatePointButtons();
        }
        
        // æ·»åŠ æ–°æ‰£åˆ†é¡¹
        function addNewDeductItem() {
            deductItems.push({ name: "æ–°æ‰£åˆ†é¡¹", points: -1, emoji: "âŒ" });
            saveData();
            updateSettingsUI();
            updatePointButtons();
        }
        
        // æ·»åŠ æ–°å¥–å“
        function addNewReward() {
            // ç”Ÿæˆä¸€ä¸ªæœªä½¿ç”¨çš„ID
            const maxId = rewards.reduce((max, reward) => Math.max(max, reward.id), 0);
            const newId = maxId + 1;
            
            rewards.push({
                id: newId,
                name: "æ–°å¥–å“",
                emoji: "ğŸ",
                description: "æè¿°ä¸€ä¸‹è¿™ä¸ªæ–°å¥–å“",
                price: 30
            });
            
            saveData();
            updateRewardsSettings();
            updateProgressBar();
        }
        
        // é‡ç½®ä»Šæ—¥æ•°æ®
        function resetTodayData() {
            score = 0;
            pointsLog = [];
            saveData();
            updateScoreDisplay();
            updateLogTable();
            updateStatistics();
        }
        
        // å¯¼å‡ºCSVæ•°æ®
        function exportToCSV() {
            const range = document.getElementById('export-range').value;
            const data = getDataForExport(range);
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = "æ—¶é—´,äº‹é¡¹,åˆ†å€¼,ç´¯è®¡åˆ†å€¼\n";
            
            data.forEach(entry => {
                const time = new Date(entry.time);
                const dateStr = `${time.getFullYear()}-${(time.getMonth() + 1).toString().padStart(2, '0')}-${time.getDate().toString().padStart(2, '0')}`;
                const timeStr = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                
                csvContent += `${dateStr} ${timeStr},${entry.item},${entry.points},${entry.totalPoints}\n`;
            });
            
            // ç”±äºç›´æ¥ä¸‹è½½å¯èƒ½ä¸è¢«æ”¯æŒï¼Œæˆ‘ä»¬æ˜¾ç¤ºæ•°æ®è®©ç”¨æˆ·å¤åˆ¶
            const csvDisplay = document.createElement('textarea');
            csvDisplay.value = csvContent;
            csvDisplay.style.width = '100%';
            csvDisplay.style.height = '200px';
            csvDisplay.style.marginTop = '20px';
            csvDisplay.style.padding = '10px';
            
            const tab4 = document.getElementById('tab4');
            
            // åˆ›å»ºCSVæ•°æ®å®¹å™¨
            const csvContainer = document.createElement('div');
            csvContainer.className = 'p-4 mt-4 rounded-xl glass';
            csvContainer.innerHTML = `
                <h3 class="text-lg font-semibold mb-3 text-girl-hotpink dark:text-girl-lightpink">CSV æ•°æ®ï¼ˆè¯·å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼‰</h3>
                <p class="mb-2 text-gray-600 dark:text-gray-300">å…¨é€‰ä¸‹æ–¹æ–‡æœ¬æ¡†å†…å®¹ï¼Œå¤åˆ¶åç²˜è´´åˆ°æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ä¿å­˜ä¸º .csv æ–‡ä»¶</p>
            `;
            csvContainer.appendChild(csvDisplay);
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®æ˜¾ç¤ºåŒºåŸŸ
            const existingContainer = tab4.querySelector('.mt-4');
            if (existingContainer) {
                existingContainer.remove();
            }
            
            // æ·»åŠ åˆ°æ ‡ç­¾é¡µ
            tab4.appendChild(csvContainer);
        }
        
        // è·å–å¯¼å‡ºæ•°æ®
        function getDataForExport(range) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            switch(range) {
                case 'today':
                    return pointsLog.filter(entry => new Date(entry.time) >= today);
                    
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    return pointsLog.filter(entry => new Date(entry.time) >= weekStart);
                    
                case 'month':
                    const monthStart = new Date(today);
                    monthStart.setDate(1);
                    return pointsLog.filter(entry => new Date(entry.time) >= monthStart);
                    
                case 'all':
                default:
                    return pointsLog;
            }
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è®¡æ—¶å™¨æŒ‰é’®
            startBtn.addEventListener('click', () => startTimer());
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);
            
            // å¥–å“å…‘æ¢ç›¸å…³
            exchangeBtn.addEventListener('click', openRewardsModal);
            closeModalBtn.addEventListener('click', closeRewardsModal);
            confirmExchangeBtn.addEventListener('click', confirmExchange);
            
            // ç‚¹å‡»æ¨¡æ€çª—å£èƒŒæ™¯å…³é—­
            rewardsModal.addEventListener('click', (e) => {
                if (e.target === rewardsModal) {
                    closeRewardsModal();
                }
            });
            
            // è®¾ç½®é¡µé¢æŒ‰é’®
            if (addNewAddItemBtn) {
                addNewAddItemBtn.addEventListener('click', addNewAddItem);
            }
            
            if (addNewDeductItemBtn) {
                addNewDeductItemBtn.addEventListener('click', addNewDeductItem);
            }
            
            if (addNewRewardBtn) {
                addNewRewardBtn.addEventListener('click', addNewReward);
            }
            
            if (resetTodayDataBtn) {
                resetTodayDataBtn.addEventListener('click', resetTodayData);
            }
            
            // å¯¼å‡ºæŒ‰é’®
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', exportToCSV);
            }
        }
        
        // å¢å¼ºçš„æ•°æ®åŠ è½½åŠŸèƒ½ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œ
        function initializeApp() {
            // è®¾ç½®æ ‡ç­¾é¡µåˆ‡æ¢
            setupTabs();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // åŠ è½½æ•°æ®
            loadData();
            
            // æ›´æ–°å…‘æ¢å†å²
            updateExchangeHistory();
        }
        
        // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†åˆå§‹åŒ–åº”ç”¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // æ¯5ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡æ•°æ®
        setInterval(saveData, 5000);
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ä¿å­˜æ•°æ®ï¼ˆç”¨æˆ·åˆ‡æ¢æ ‡ç­¾é¡µæˆ–æœ€å°åŒ–æµè§ˆå™¨ï¼‰
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                saveData();
            }
        });
        
        // é¡µé¢å…³é—­å‰ä¿å­˜æ•°æ®
        window.addEventListener('beforeunload', saveData);
        
        // åœ¨å¾®ä¿¡ç¯å¢ƒä¸­å¯èƒ½éœ€è¦çš„é¢å¤–å¤„ç†
        // å¾®ä¿¡ç½‘é¡µSDKåŠ è½½å®Œæˆåæ‰§è¡Œ
        if (typeof WeixinJSBridge !== 'undefined') {
            document.addEventListener('WeixinJSBridgeReady', saveData);
        }
    </script>


</body></html>